import"../chunks/DsnmJJEf.js";import{o as Be}from"../chunks/CB4Olaad.js";import{p as Pe,b as m,d as Re,c as r,s as n,t as D,g as t,a as Ie,e as l,r as s,f as de,n as Le,h as pe}from"../chunks/B0s2WIk6.js";import{d as je,s as K}from"../chunks/lNAYbgwX.js";import{i as C}from"../chunks/BU0dDrke.js";import{e as Me,i as Te}from"../chunks/C9ggWJOn.js";import{f as y,a as p,c as ve}from"../chunks/C0qyjTH1.js";import{r as Ee,s as W}from"../chunks/54piRQ0V.js";import{b as q}from"../chunks/CGosTEss.js";import{b as Ge}from"../chunks/AbZRzsBO.js";var Ue=y('<div class="text-[11px] text-slate-400">暂无消息。连接成功后，在上方输入框中发送文字或图片即可。</div>'),ze=y("<div> </div>"),Fe=y('<div class="flex items-start gap-2"><span> </span> <img alt="图片消息" class="border border-slate-400 max-h-32 max-w-40 object-contain"/></div>'),Ke=y('<div class="mb-1"><!></div>'),We=y('<div class="fixed inset-0 z-40 flex items-center justify-center bg-black/70"><div class="border border-slate-400 bg-black px-3 py-2 max-w-[90vw] max-h-[90vh]"><div class="mb-2 flex justify-between text-[11px] text-slate-100"><span>图片预览</span> <button type="button" class="border border-slate-300 px-2 py-px text-[11px] bg-slate-800">关闭</button></div> <button type="button" class="border border-slate-500 bg-black max-h-[80vh] max-w-[80vw] p-0"><img alt="预览" class="block max-h-[80vh] max-w-[80vw] object-contain"/></button></div></div>'),qe=y(`<main class="min-h-screen bg-slate-100"><div class="mx-auto max-w space-y-3 text-xs text-slate-800"><header class="border-b border-slate-300 pb-2"><h1 class="text-base font-semibold text-slate-900">WebRTC 点对点聊天（仅支持文本和图片）</h1> <p class="mt-1 text-[11px] text-slate-500">开两个浏览器窗口（或两台设备）打开本页面，通过复制 / 粘贴 Offer
                / Answer JSON 建立 DataChannel，然后就可以点对点聊天。</p></header> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">步骤 1 · 建立连接</div> <ul class="mb-2 list-decimal space-y-1 pl-4 text-[11px] text-slate-500"><li>窗口 A 点击「创建 Offer」，复制生成的 JSON 发给窗口 B。</li> <li>窗口 B 将 JSON 粘贴到「远端描述」框，点击「应用 Offer 并生成
                    Answer」，再把生成的 JSON 发回 A。</li> <li>窗口 A 将 B 的 JSON 粘贴到「远端描述」框，点击「应用
                    Answer」。稍等片刻，连接成功后即可聊天。</li></ul> <div class="mt-2 flex flex-wrap gap-2"><button type="button" class="border border-slate-400 px-2 py-1">创建 Offer（窗口 A）</button> <button type="button" class="border border-slate-400 px-2 py-1">应用 Offer 并生成 Answer（窗口 B）</button> <button type="button" class="border border-slate-400 px-2 py-1">应用 Answer（窗口 A）</button> <span class="self-center text-[11px] text-slate-500"> </span></div></section> <section class="grid gap-3 md:grid-cols-2"><div class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">本地描述（生成后复制给对方）</div> <textarea class="h-40 w-full border border-slate-300 bg-slate-50 p-1 font-mono text-[11px] leading-snug" readonly=""></textarea></div> <div class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">远端描述（粘贴对方发来的 JSON）</div> <textarea class="h-40 w-full border border-slate-300 bg-white p-1 font-mono text-[11px] leading-snug" placeholder="粘贴对方给你的 Offer 或 Answer JSON"></textarea></div></section> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">聊天</div> <div class="mb-2 flex gap-2"><input class="flex-1 border border-slate-300 px-2 py-1 text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送文字</button></div> <div class="mb-2 flex items-center gap-2 text-[11px]"><input type="file" accept="image/*" class="border border-slate-300 px-1 py-[3px] text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送图片</button> <span class="text-slate-400">建议图片小于 2MB，传输更稳定。</span></div> <div class="max-h-72 overflow-auto border border-slate-200 bg-slate-50 p-2 text-[11px] leading-snug"><!></div></section></div> <!></main>`);function rt(fe,be){Pe(be,!0);let c=null,i=null,A=m(""),x=m(""),_=m(Re([])),H=1,g=m(""),v=m(null),O=m(!1),J=m(null);function N(e,a){l(_,[...t(_),{id:H++,from:e,kind:"text",text:a}],!0)}function B(e,a){const o=URL.createObjectURL(a);l(_,[...t(_),{id:H++,from:e,kind:"image",url:o}],!0)}function f(e){console.log(e),N("me",`[系统] ${e}`)}function Q(){return c||(c=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),c.oniceconnectionstatechange=()=>{const e=c?.iceConnectionState;console.log("ICE state:",e),e==="connected"&&(l(O,!0),f("连接已建立，可以开始聊天。")),(e==="disconnected"||e==="failed"||e==="closed")&&(l(O,!1),f("连接已断开或失败。"))},c.ondatachannel=e=>{i=e.channel,V()},c)}function V(){i&&(i.onopen=()=>{f("DataChannel 已打开。")},i.onclose=()=>{f("DataChannel 已关闭。"),l(O,!1)},i.onmessage=e=>{const a=e.data;if(a instanceof ArrayBuffer){const o=new Blob([a]);B("peer",o);return}a instanceof Blob?B("peer",a):N("peer",String(a??""))})}function X(e){return e.iceGatheringState==="complete"?Promise.resolve():new Promise(a=>{const o=()=>{e.iceGatheringState==="complete"&&(e.removeEventListener("icegatheringstatechange",o),a())};e.addEventListener("icegatheringstatechange",o)})}async function ue(){const e=Q();i=e.createDataChannel("chat"),V();const a=await e.createOffer();await e.setLocalDescription(a),await X(e),l(A,JSON.stringify(e.localDescription),!0),f("已生成 Offer，请复制到对方浏览器。")}async function me(){const e=Q();if(!t(x).trim()){alert("请先粘贴对方给你的 Offer JSON");return}const a=JSON.parse(t(x));await e.setRemoteDescription(a);const o=await e.createAnswer();await e.setLocalDescription(o),await X(e),l(A,JSON.stringify(e.localDescription),!0),f("已生成 Answer，请复制给对方。")}async function xe(){if(!c){alert("请先在本窗口点击“创建 Offer”。");return}if(!t(x).trim()){alert("请先粘贴对方给你的 Answer JSON");return}const e=JSON.parse(t(x));await c.setRemoteDescription(e),f("已应用远端 Answer，等待连接建立…")}function Y(){if(!i||i.readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}t(g).trim()&&(i.send(t(g)),N("me",t(g)),l(g,""))}async function _e(){if(!i||i.readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}if(!t(v)||!t(v).files||t(v).files.length===0){alert("请先选择一张图片。");return}const e=t(v).files[0];if(e.size>2*1024*1024){alert("图片太大了，建议小于 2MB。");return}i.send(e),B("me",e),t(v).value=""}function Z(){l(J,null)}Be(()=>{i?.close(),c?.close()});var P=qe(),R=r(P),I=n(r(R),2),$=n(r(I),4),ee=r($);ee.__click=ue;var te=n(ee,2);te.__click=me;var ae=n(te,2);ae.__click=xe;var re=n(ae,2),ge=r(re);s(re),s($),s(I);var L=n(I,2),j=r(L),se=n(r(j),2);de(se),s(j);var ne=n(j,2),oe=n(r(ne),2);de(oe),s(ne),s(L);var ie=n(L,2),M=n(r(ie),2),k=r(M);Ee(k),k.__keydown=e=>e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Y());var he=n(k,2);he.__click=Y,s(M);var T=n(M,2),le=r(T);Ge(le,e=>l(v,e),()=>t(v));var we=n(le,2);we.__click=_e,Le(2),s(T);var ce=n(T,2),ye=r(ce);{var Oe=e=>{var a=Ue();p(e,a)},ke=e=>{var a=ve(),o=pe(a);Me(o,17,()=>t(_),Te,(S,d)=>{var b=Ke(),E=r(b);{var u=h=>{var w=ze(),G=r(w);s(w),D(()=>K(G,`${t(d).from==="me"?"我：":"对方："}${t(d).text??""}`)),p(h,w)},De=h=>{var w=ve(),G=pe(w);{var Ce=U=>{var z=Fe(),F=r(z),Je=r(F,!0);s(F);var Ne=n(F,2);s(z),D(()=>{K(Je,t(d).from==="me"?"我：":"对方："),W(Ne,"src",t(d).url)}),p(U,z)};C(G,U=>{t(d).kind==="image"&&U(Ce)},!0)}p(h,w)};C(E,h=>{t(d).kind==="text"?h(u):h(De,!1)})}s(b),p(S,b)}),p(e,a)};C(ye,e=>{t(_).length===0?e(Oe):e(ke,!1)})}s(ce),s(ie),s(R);var Se=n(R,2);{var Ae=e=>{var a=We();a.__click=Z;var o=r(a);o.__click=u=>u.stopPropagation();var S=r(o),d=n(r(S),2);d.__click=u=>{u.stopPropagation(),Z()},s(S);var b=n(S,2);b.__click=u=>u.stopPropagation();var E=r(b);s(b),s(o),s(a),D(()=>W(E,"src",t(J))),p(e,a)};C(Se,e=>{t(J)&&e(Ae)})}s(P),D(()=>{K(ge,`当前状态：${t(O)?"已连接 ✅":"未连接"}`),W(k,"placeholder",t(O)?"输入要发送的消息…":"请先完成上面的连接步骤")}),q(se,()=>t(A),e=>l(A,e)),q(oe,()=>t(x),e=>l(x,e)),q(k,()=>t(g),e=>l(g,e)),p(fe,P),Ie()}je(["click","keydown"]);export{rt as component};
