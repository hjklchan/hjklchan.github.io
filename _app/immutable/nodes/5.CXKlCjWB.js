import"../chunks/DsnmJJEf.js";import{o as Fe}from"../chunks/U1Hji-hX.js";import{p as ze,c as i,s,t as qe,g as a,a as Be,e as n,b as _,r as l,h as pe,n as He,f as F}from"../chunks/D2i5E-qJ.js";import{d as Ke,e as ve,s as Qe}from"../chunks/q7d5fFKL.js";import{i as b}from"../chunks/yNFHT3RV.js";import{f as y,a as c,t as h,c as z}from"../chunks/DAGe5NMS.js";import{r as We,s as fe}from"../chunks/CWPoSXa_.js";import{b as q}from"../chunks/BqHekL-a.js";import{b as Xe}from"../chunks/DdqTk4WF.js";var Ye=y('<button type="button" class="border border-slate-400 bg-white px-2 py-0.5 text-[11px] hover:bg-slate-100">重新生成 Offer</button>'),Ze=y('<span class="text-emerald-600">已复制</span>'),$e=y('<button type="button" class="border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">从远端 Offer 生成 Answer</button>'),et=y('<button type="button" class="border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">应用对方的 Answer</button>'),tt=y('<span class="text-slate-500">请选择“我是发起端”或“我是应答端”后再操作。</span>'),at=y('<span class="text-emerald-600">已复制</span>'),rt=y(`<main class="min-h-screen bg-slate-100"><div class="mx-auto max-w space-y-3 text-xs text-slate-800"><header class="border-b border-slate-300 pb-4 flex flex-col gap-2 md:flex-row md:items-end md:justify-between"><h1 class="text-base font-semibold text-slate-900">P2P Media</h1></header> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">先选择角色并建立连接</div> <p class="mb-2 text-[11px] text-slate-500">在两台设备或两个浏览器页面中分别打开本页面：一边选择“我是发起端”，另一边选择“我是应答端”，再按提示复制
                / 粘贴 Offer / Answer JSON 信息。</p> <div class="mt-2 flex flex-wrap gap-2 items-center"><button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-xs uppercase tracking-[0.15em] text-white">我是发起端</button> <button type="button" class="border border-slate-400 bg-white px-3 py-1 text-xs uppercase tracking-[0.15em] text-slate-900 hover:bg-slate-100">我是应答端</button> <span class="ml-auto text-[11px] text-slate-500">当前角色： <!> </span></div></section> <section class="grid gap-3 md:grid-cols-2 mb-5"><div class="border border-slate-300 bg-white p-2"><div class="mb-1 flex items-center justify-between"><div class="text-xs font-medium text-slate-700"><!></div> <div class="flex items-center gap-2"><!> <button type="button" class="border border-slate-400 bg白 px-2 py-0.5 text-[11px] hover:bg-slate-100">复制</button></div></div> <textarea class="h-40 w-full border border-slate-300 bg-slate-50 p-1 font-mono text-[11px] leading-snug" readonly=""></textarea> <div class="mt-1 flex items-center justify-between text-[11px] text-slate-500"><span>生成后复制整段 JSON 发送给对方。</span> <!></div></div> <div class="border border-slate-300 bg-white p-2"><div class="mb-1 flex items-center justify-between"><div class="text-xs font-medium text-slate-700">远端描述（粘贴对方给你的 JSON）</div> <button type="button" class="border border-slate-400 bg白 px-2 py-0.5 text-[11px] hover:bg-slate-100">复制</button></div> <textarea class="h-40 w-full border border-slate-300 bg-white p-1 font-mono text-[11px] leading-snug"></textarea> <div class="mt-2 flex flex-wrap gap-2 text-[11px] items-center"><!> <!></div></div></section> <section class="border border-slate-300 bg-slate-50 p-3"><div class="mb-2 text-sm font-medium text-slate-800">步骤 2 · 同步视频地址 & 播放控制</div> <div class="mb-3 flex flex-col gap-2 md:flex-row md:items-center"><div class="flex-1"><label for="" class="block text-[11px] text-slate-600 mb-1">视频地址（例如：mp4 URL）</label> <input class="w-full border border-slate-400 px-2 py-1 text-[11px]"/></div> <div class="mt-2 md:mt-5 md:ml-3 flex gap-2 text-[11px]"><button type="button" class="border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">将地址同步给对方</button></div></div> <div><video class="w-full border border-slate-400 bg-black" controls>您的浏览器不支持 video 标签。 <track kind="captions"/></video> <p class="mt-1 text-[11px] text-slate-600">两端加载同一段视频后，任意一端点击播放 /
                    暂停，另一端会尽量同步当前时间点和状态。</p></div></section></div></main>`,2);function ft(me,ue){ze(ue,!0);const be=[{urls:"stun:stun.l.google.com:19302"}];let v=_("none"),f=null,d=null,O=_(null),x=_(""),m=_(""),A=_(!1),R=_(!1),J=_(!1),w=_("https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"),g=null,k=!1;function T(){return f||(f=new RTCPeerConnection({iceServers:be}),f.oniceconnectionstatechange=()=>{const e=f?.iceConnectionState;e==="connected"&&n(J,!0),(e==="disconnected"||e==="failed"||e==="closed")&&n(J,!1)},f.ondatachannel=e=>{d=e.channel,B()},f)}function B(){d&&(d.onopen=()=>{n(O,setInterval(()=>{d?.readyState==="open"&&(d.send(JSON.stringify({kind:"ping",t:Date.now()})),console.log("发送心跳"))},15e3),!0)},d.onclose=()=>{a(O)&&(clearInterval(a(O)),n(O,null)),n(J,!1)},d.onmessage=e=>{const t=String(e.data??"");let r;try{r=JSON.parse(t)}catch{console.error("Unknown message:",t);return}if(r){if(r.kind==="ping")return;if(r.kind==="media-url"){typeof r.url=="string"&&r.url.trim()&&n(w,r.url,!0);return}if(r.kind==="media-control"){if(!g)return;if(k=!0,typeof r.time=="number")try{g.currentTime=r.time}catch(u){console.error("Failed to set currentTime",u)}r.action==="play"?g.play().catch(u=>console.error("remote play failed",u)):r.action==="pause"&&g.pause();return}}})}function H(e){return e.iceGatheringState==="complete"?Promise.resolve():new Promise(t=>{const r=()=>{e.iceGatheringState==="complete"&&(e.removeEventListener("icegatheringstatechange",r),t())};e.addEventListener("icegatheringstatechange",r)})}async function K(){const e=T();d=e.createDataChannel("media"),B();const t=await e.createOffer();await e.setLocalDescription(t),await H(e),n(x,JSON.stringify(e.localDescription),!0)}async function xe(){const e=T();if(!a(m).trim()){alert("请先粘贴发起端给你的 Offer JSON。");return}const t=JSON.parse(a(m));await e.setRemoteDescription(t);const r=await e.createAnswer();await e.setLocalDescription(r),await H(e),n(x,JSON.stringify(e.localDescription),!0)}async function _e(){if(!f){alert("请先作为发起端生成 Offer。");return}if(!a(m).trim()){alert("请粘贴应答端给你的 Answer JSON。");return}const e=JSON.parse(a(m));await f.setRemoteDescription(e)}function ge(){n(v,"initiator"),n(x,""),n(m,""),K()}function ye(){n(v,"responder"),n(x,""),n(m,""),T()}async function he(){if(!a(x).trim()){alert("当前没有可复制的内容。");return}try{await navigator.clipboard.writeText(a(x)),n(A,!0),setTimeout(()=>n(A,!1),1500)}catch(e){console.error(e),alert("复制失败，请手动复制文本。")}}async function we(){if(!a(m).trim()){alert("当前没有可复制的内容。");return}try{await navigator.clipboard.writeText(a(m)),n(R,!0),setTimeout(()=>n(R,!1),1500)}catch(e){console.error(e),alert("复制失败，请手动复制文本。")}}function ke(){if(!d||d.readyState!=="open"){alert("连接尚未建立，无法同步地址。");return}const e={kind:"media-url",url:a(w)};d.send(JSON.stringify(e))}function Q(e){if(!d||d.readyState!=="open")return;const t=g?.currentTime??0,r={kind:"media-control",action:e,time:t};d.send(JSON.stringify(r))}function Se(){if(k){k=!1;return}Q("play")}function Oe(){if(k){k=!1;return}Q("pause")}Fe(()=>{d?.close(),f?.close()});var C=rt(),W=i(C),P=s(i(W),2),X=s(i(P),4),Y=i(X);Y.__click=ge;var Z=s(Y,2);Z.__click=ye;var $=s(Z,2),ee=s(i($));{var Je=e=>{var t=h("发起端");c(e,t)},Ne=e=>{var t=z(),r=F(t);{var u=o=>{var p=h("应答端");c(o,p)},S=o=>{var p=h("未选择");c(o,p)};b(r,o=>{a(v)==="responder"?o(u):o(S,!1)},!0)}c(e,t)};b(ee,e=>{a(v)==="initiator"?e(Je):e(Ne,!1)})}var De=s(ee);l($),l(X),l(P);var E=s(P,2),L=i(E),I=i(L),j=i(I),Ae=i(j);{var Re=e=>{var t=h("本地描述（发起端的 Offer / Answer）");c(e,t)},Te=e=>{var t=z(),r=F(t);{var u=o=>{var p=h("本地描述（应答端生成的 Answer）");c(o,p)},S=o=>{var p=h("本地描述");c(o,p)};b(r,o=>{a(v)==="responder"?o(u):o(S,!1)},!0)}c(e,t)};b(Ae,e=>{a(v)==="initiator"?e(Re):e(Te,!1)})}l(j);var te=s(j,2),ae=i(te);{var Ce=e=>{var t=Ye();t.__click=K,c(e,t)};b(ae,e=>{a(v)==="initiator"&&e(Ce)})}var Pe=s(ae,2);Pe.__click=he,l(te),l(I);var M=s(I,2);pe(M);var re=s(M,2),Ee=s(i(re),2);{var Le=e=>{var t=Ze();c(e,t)};b(Ee,e=>{a(A)&&e(Le)})}l(re),l(L);var se=s(L,2),U=i(se),Ie=s(i(U),2);Ie.__click=we,l(U);var N=s(U,2);pe(N);var ne=s(N,2),oe=i(ne);{var je=e=>{var t=$e();t.__click=xe,c(e,t)},Me=e=>{var t=z(),r=F(t);{var u=o=>{var p=et();p.__click=_e,c(o,p)},S=o=>{var p=tt();c(o,p)};b(r,o=>{a(v)==="initiator"?o(u):o(S,!1)},!0)}c(e,t)};b(oe,e=>{a(v)==="responder"?e(je):e(Me,!1)})}var Ue=s(oe,2);{var Ge=e=>{var t=at();c(e,t)};b(Ue,e=>{a(R)&&e(Ge)})}l(ne),l(se),l(E);var ie=s(E,2),G=s(i(ie),2),V=i(G),le=s(i(V),2);We(le),l(V);var ce=s(V,2),Ve=i(ce);Ve.__click=ke,l(ce),l(G);var de=s(G,2),D=i(de);Xe(D,e=>g=e,()=>g),He(2),l(de),l(ie),l(W),l(C),qe(()=>{Qe(De,` · 状态：${a(J)?"已连接 ✅":"未连接"}`),fe(N,"placeholder",a(v)==="responder"?"粘贴发起端给你的 Offer JSON":a(v)==="initiator"?"粘贴应答端给你的 Answer JSON":"请先在上方选择角色（发起端 / 应答端）"),fe(D,"src",a(w))}),q(M,()=>a(x),e=>n(x,e)),q(N,()=>a(m),e=>n(m,e)),q(le,()=>a(w),e=>n(w,e)),ve("play",D,Se),ve("pause",D,Oe),c(me,C),Be()}Ke(["click"]);export{ft as component};
