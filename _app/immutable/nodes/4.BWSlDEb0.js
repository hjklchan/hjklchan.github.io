import"../chunks/DsnmJJEf.js";import{o as Ze}from"../chunks/BuerFCfO.js";import{p as $e,b as w,d as et,c as i,s as n,t as G,a as tt,e as o,g as t,r as l,f as J,h as he,n as ye}from"../chunks/xT3Db35F.js";import{d as at,s as $}from"../chunks/D_dDdLPh.js";import{i as b}from"../chunks/cVz-UtST.js";import{e as rt,i as st}from"../chunks/CCP32oJ4.js";import{f as _,a as s,t as N,c as P}from"../chunks/08zest7Z.js";import{r as nt,s as ee}from"../chunks/CsfNHzqd.js";import{b as te}from"../chunks/58IP9Nz3.js";import{b as ot}from"../chunks/BKoGS_wq.js";var it=_('<button type="button" class="mt-2 border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">重新生成 Offer</button>'),lt=_('<button type="button" class="border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">从远端 Offer 生成 Answer</button>'),ct=_('<button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-amber-50">应用对方的 Answer</button>'),vt=_('<span class="text-slate-500">请选择“我是发起端”或“我是应答端”后再操作。</span>'),dt=_('<div class="text-[11px] text-slate-400">暂无消息。连接成功后，在上方输入框中发送文字或图片即可。</div>'),pt=_("<div> </div>"),ft=_('<div class="flex items-start gap-2"><span> </span> <img alt="图片消息" class="border border-slate-400 max-h-32 max-w-40 object-contain"/></div>'),bt=_('<div class="mb-1"><!></div>'),ut=_('<section class="grid gap-3 md:grid-cols-2"><div class="border border-slate-300 bg-white p-2"><div class="mb-1 flex items-center justify-between"><div class="text-xs font-medium text-slate-700"><!></div></div> <textarea class="h-40 w-full border border-slate-300 bg-slate-50 p-1 font-mono text-[11px] leading-snug" readonly=""></textarea> <button type="button" class="mt-2 bg-sky-600 px-3 py-1 text-amber-50">一键复制</button> <!> <span class="text-[11px] text-slate-500">生成后复制整段 JSON 发送给对方。</span></div> <div class="border border-slate-300 bg-white p-2"><div class="mb-1 text-xs font-medium text-slate-700">远端描述（粘贴对方给你的 JSON）</div> <textarea class="h-40 w-full border border-slate-300 bg-white p-1 font-mono text-[11px] leading-snug"></textarea> <div class="mt-2 flex flex-wrap gap-2 text-[11px]"><!></div></div></section> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">聊天</div> <div class="mb-2 flex gap-2"><input class="flex-1 border border-slate-300 px-2 py-1 text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送文字</button></div> <div class="mb-2 flex items-center gap-2 text-[11px]"><input type="file" accept="image/*" class="border border-slate-300 px-1 py-[3px] text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送图片</button> <span class="text-slate-400">建议图片小于 2MB，传输更稳定。</span></div> <div class="max-h-72 overflow-auto border border-slate-200 bg-slate-50 p-2 text-[11px] leading-snug"><!></div></section>',1),xt=_(`<main class="min-h-screen bg-slate-100"><div class="mx-auto max-w space-y-3 text-xs text-slate-800"><header class="border-b border-slate-300 pb-2"><h1 class="text-base font-semibold text-slate-900">WebRTC 点对点聊天（仅支持文本和图片）</h1></header> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">先选择角色并建立连接</div> <p class="mb-2 text-[11px] text-slate-500">在两台设备或两个浏览器页面中分别打开本页面：一边选择“我是发起端”，另一边选择“我是应答端”，再按提示复制
                / 粘贴 Offer / Answer JSON 信息。</p> <div class="mt-2 flex flex-wrap gap-2 items-center"><button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-xs uppercase tracking-[0.15em] text-white">我是发起端</button> <button type="button" class="border border-slate-400 bg-white px-3 py-1 text-xs uppercase tracking-[0.15em] text-slate-900 hover:bg-slate-100">我是应答端</button> <span class="ml-auto text-[11px] text-slate-500">当前角色： <!> </span></div></section> <!></div></main>`);function Ct(we,ke){$e(ke,!0);let f=w("none"),u=null,p=null,h=w(""),y=w(""),ae=w(!1),D=w(et([])),re=1,S=w(""),k=w(null),R=w(!1);function Oe(){o(f,"initiator"),o(h,""),o(y,""),oe()}function De(){o(f,"responder"),o(h,""),o(y,""),F()}function U(e,r){o(D,[...t(D),{id:re++,from:e,kind:"text",text:r}],!0)}function z(e,r){const d=URL.createObjectURL(r);o(D,[...t(D),{id:re++,from:e,kind:"image",url:d}],!0)}function O(e){console.log(e),U("me",`[系统] ${e}`)}function F(){return u||(u=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),u.oniceconnectionstatechange=()=>{const e=u?.iceConnectionState;console.log("ICE state:",e),e==="connected"&&(o(R,!0),O("连接已建立，可以开始聊天。")),(e==="disconnected"||e==="failed"||e==="closed")&&(o(R,!1),O("连接已断开或失败。"))},u.ondatachannel=e=>{p=e.channel,se()},u)}function se(){p&&(p.onopen=()=>{O("DataChannel 已打开。")},p.onclose=()=>{O("DataChannel 已关闭。"),o(R,!1)},p.onmessage=e=>{const r=e.data;if(r instanceof ArrayBuffer){const d=new Blob([r]);z("peer",d);return}r instanceof Blob?z("peer",r):U("peer",String(r??""))})}function ne(e){return e.iceGatheringState==="complete"?Promise.resolve():new Promise(r=>{const d=()=>{e.iceGatheringState==="complete"&&(e.removeEventListener("icegatheringstatechange",d),r())};e.addEventListener("icegatheringstatechange",d)})}async function oe(){const e=F();p=e.createDataChannel("chat"),se();const r=await e.createOffer();await e.setLocalDescription(r),await ne(e),o(h,JSON.stringify(e.localDescription),!0),O("已生成 Offer，请复制到对方浏览器。")}async function Se(){const e=F();if(!t(y).trim()){alert("请先粘贴对方给你的 Offer JSON");return}const r=JSON.parse(t(y));await e.setRemoteDescription(r);const d=await e.createAnswer();await e.setLocalDescription(d),await ne(e),o(h,JSON.stringify(e.localDescription),!0),O("已生成 Answer，请复制给对方。")}async function Ce(){if(!u){alert("请先在本窗口点击“创建 Offer”。");return}if(!t(y).trim()){alert("请先粘贴对方给你的 Answer JSON");return}const e=JSON.parse(t(y));await u.setRemoteDescription(e),O("已应用远端 Answer，等待连接建立…")}function ie(){if(!p||p.readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}t(S).trim()&&(p.send(t(S)),U("me",t(S)),o(S,""))}async function Ae(){if(!p||p.readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}if(!t(k)||!t(k).files||t(k).files.length===0){alert("请先选择一张图片。");return}const e=t(k).files[0];if(e.size>2*1024*1024){alert("图片太大了，建议小于 2MB。");return}p.send(e),z("me",e),t(k).value=""}async function Je(){if(!t(h)?.trim()){alert("当前没有可复制的内容。");return}try{await navigator.clipboard.writeText(t(h)),o(ae,!0),setTimeout(()=>o(ae,!1),1500)}catch(e){console.error(e),alert("复制失败，请手动选中内容复制。")}}Ze(()=>{p?.close(),u?.close()});var K=xt(),le=i(K),W=n(i(le),2),ce=n(i(W),4),ve=i(ce);ve.__click=Oe;var de=n(ve,2);de.__click=De;var pe=n(de,2),fe=n(i(pe));{var Ne=e=>{var r=N("发起端");s(e,r)},Re=e=>{var r=P(),d=J(r);{var T=g=>{var L=N("应答端");s(g,L)},I=g=>{var L=N("未选择");s(g,L)};b(d,g=>{t(f)==="responder"?g(T):g(I,!1)},!0)}s(e,r)};b(fe,e=>{t(f)==="initiator"?e(Ne):e(Re,!1)})}var Te=n(fe);l(pe),l(ce),l(W);var Ie=n(W,2);{var Le=e=>{var r=ut(),d=J(r),T=i(d),I=i(T),g=i(I),L=i(g);{var Be=a=>{var c=N("本地描述（发起端的 Offer）");s(a,c)},Me=a=>{var c=P(),M=J(c);{var E=v=>{var m=N("本地描述（应答端生成的 Answer）");s(v,m)},x=v=>{var m=N("本地描述");s(v,m)};b(M,v=>{t(f)==="responder"?v(E):v(x,!1)},!0)}s(a,c)};b(L,a=>{t(f)==="initiator"?a(Be):a(Me,!1)})}l(g),l(I);var q=n(I,2);he(q);var be=n(q,2);be.__click=Je;var Ee=n(be,2);{var Pe=a=>{var c=it();c.__click=oe,s(a,c)};b(Ee,a=>{t(f)==="initiator"&&a(Pe)})}ye(2),l(T);var ue=n(T,2),j=n(i(ue),2);he(j);var xe=n(j,2),je=i(xe);{var Ge=a=>{var c=lt();c.__click=Se,s(a,c)},Ue=a=>{var c=P(),M=J(c);{var E=v=>{var m=ct();m.__click=Ce,s(v,m)},x=v=>{var m=vt();s(v,m)};b(M,v=>{t(f)==="initiator"?v(E):v(x,!1)},!0)}s(a,c)};b(je,a=>{t(f)==="responder"?a(Ge):a(Ue,!1)})}l(xe),l(ue),l(d);var me=n(d,2),H=n(i(me),2),B=i(H);nt(B),B.__keydown=a=>a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),ie());var ze=n(B,2);ze.__click=ie,l(H);var Q=n(H,2),_e=i(Q);ot(_e,a=>o(k,a),()=>t(k));var Fe=n(_e,2);Fe.__click=Ae,ye(2),l(Q);var ge=n(Q,2),Ke=i(ge);{var We=a=>{var c=dt();s(a,c)},qe=a=>{var c=P(),M=J(c);rt(M,17,()=>t(D),st,(E,x)=>{var v=bt(),m=i(v);{var He=C=>{var A=pt(),V=i(A);l(A),G(()=>$(V,`${t(x).from==="me"?"我：":"对方："}${t(x).text??""}`)),s(C,A)},Qe=C=>{var A=P(),V=J(A);{var Ve=X=>{var Y=ft(),Z=i(Y),Xe=i(Z,!0);l(Z);var Ye=n(Z,2);l(Y),G(()=>{$(Xe,t(x).from==="me"?"我：":"对方："),ee(Ye,"src",t(x).url)}),s(X,Y)};b(V,X=>{t(x).kind==="image"&&X(Ve)},!0)}s(C,A)};b(m,C=>{t(x).kind==="text"?C(He):C(Qe,!1)})}l(v),s(E,v)}),s(a,c)};b(Ke,a=>{t(D).length===0?a(We):a(qe,!1)})}l(ge),l(me),G(()=>{ee(j,"placeholder",t(f)==="responder"?"粘贴发起端给你的 Offer JSON":t(f)==="initiator"?"粘贴应答端给你的 Answer JSON":"请先在上方选择角色（发起端 / 应答端）"),ee(B,"placeholder",t(R)?"输入要发送的消息…":"请先完成上面的连接步骤")}),te(q,()=>t(h),a=>o(h,a)),te(j,()=>t(y),a=>o(y,a)),te(B,()=>t(S),a=>o(S,a)),s(e,r)};b(Ie,e=>{t(f)!=="none"&&e(Le)})}l(le),l(K),G(()=>$(Te,` · 状态：${t(R)?"已连接 ✅":"未连接"}`)),s(we,K),tt()}at(["click","keydown"]);export{Ct as component};
