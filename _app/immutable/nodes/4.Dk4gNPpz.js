import"../chunks/DsnmJJEf.js";import{o as Fe}from"../chunks/U1Hji-hX.js";import{p as Ke,b as u,d as Oe,c as i,s as r,t as F,a as We,e as a,g as e,u as Se,r as l,f as A,n as H,h as Q}from"../chunks/D2i5E-qJ.js";import{d as qe,s as oe}from"../chunks/q7d5fFKL.js";import{i as h}from"../chunks/yNFHT3RV.js";import{e as He,i as Qe}from"../chunks/C_eyMwtJ.js";import{f as x,a as c,t as ie,c as K}from"../chunks/DAGe5NMS.js";import{r as Ve,s as V}from"../chunks/CWPoSXa_.js";import{b as W}from"../chunks/BqHekL-a.js";import{b as Xe}from"../chunks/DdqTk4WF.js";var Ye=x(`<button type="button" class="border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">通过对方 Offer 生成 Answer</button> <span>生成 Answer
                                    后右侧会出现本地描述，将本地描述再发给对方。</span>`,1),Ze=x('<button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-amber-50">应用对方的 Answer</button>'),$e=x('<span class="text-slate-500">请选择“我是发起端”或“我是应答端”后再操作。</span>'),et=x('<div class="border border-slate-300 bg-white p-2"><div class="mb-1 flex items-center justify-between"><div class="text-xs font-medium text-slate-700">本地描述（复制再发回给对方）</div></div> <textarea class="h-40 w-full border border-slate-300 bg-slate-50 p-1 font-mono text-[11px] leading-snug" readonly=""></textarea> <button type="button" class="mt-2 bg-sky-600 px-3 py-1 text-amber-50">一键复制</button> <span class="text-[11px] text-slate-500">生成后复制整段 JSON 发送给对方。</span></div>'),tt=x('<div class="border border-slate-300 bg-white p-2"><div class="mb-1 text-xs font-medium text-slate-700">先粘贴对方给你的 Offer</div> <textarea class="h-40 w-full border border-slate-300 bg-white p-1 font-mono text-[11px] leading-snug"></textarea> <div class="mt-2 flex flex-wrap gap-2 text-[11px]"><!></div></div> <!>',1),at=x('<div class="border border-slate-300 bg-white p-2"><div class="mb-1 flex items-center justify-between"><div class="text-xs font-medium text-slate-700">本地描述（发起端的 Offer）</div></div> <textarea class="h-40 w-full border border-slate-300 bg-slate-50 p-1 font-mono text-[11px] leading-snug" readonly=""></textarea> <button type="button" class="mt-2 bg-sky-600 px-3 py-1 text-amber-50">一键复制</button> <button type="button" class="mt-2 border border-slate-400 bg-white px-3 py-1 hover:bg-slate-100">重新生成 Offer</button> <span class="text-[11px] text-slate-500">生成后复制整段 JSON 发送给对方。</span></div>  <div class="border border-slate-300 bg-white p-2"><div class="mb-1 text-xs font-medium text-slate-700">远端描述（粘贴对方给你的 JSON）</div> <textarea class="h-40 w-full border border-slate-300 bg-white p-1 font-mono text-[11px] leading-snug"></textarea> <div class="mt-2 flex flex-wrap gap-2 text-[11px]"><button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-amber-50">应用对方的 Answer</button></div></div>',1),rt=x('<div class="text-[11px] text-slate-400">暂无消息。连接成功后，在上方输入框中发送文字或图片即可。</div>'),st=x("<div> </div>"),nt=x('<div class="flex items-start gap-2"><span> </span> <img alt="图片消息" class="border border-slate-400 max-h-32 max-w-40 object-contain"/></div>'),ot=x('<div class="mb-1"><!></div>'),it=x('<section class="grid gap-3 md:grid-cols-2"><!></section> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">聊天</div> <div class="mb-2 flex gap-2"><input class="flex-1 border border-slate-300 px-2 py-1 text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送文字</button></div> <div class="mb-2 flex items-center gap-2 text-[11px]"><input type="file" accept="image/*" class="border border-slate-300 px-1 py-[3px] text-[11px]"/> <button type="button" class="border border-slate-400 px-2 py-1 text-[11px]">发送图片</button> <span class="text-slate-400">建议图片小于 2MB，传输更稳定。</span></div> <div class="max-h-72 overflow-auto border border-slate-200 bg-slate-50 p-2 text-[11px] leading-snug"><!></div></section>',1),lt=x(`<main class="min-h-screen bg-slate-100"><div class="mx-auto max-w space-y-3 text-xs text-slate-800"><header class="border-b border-slate-300 pb-2"><h1 class="text-base font-semibold text-slate-900">WebRTC 点对点聊天（仅支持文本和图片）</h1></header> <section class="border border-slate-300 bg-white p-2"><div class="mb-1 font-medium">先选择角色并建立连接</div> <p class="mb-2 text-[11px] text-slate-500">在两台设备或两个浏览器页面中分别打开本页面：一边选择“我是发起端”，另一边选择“我是应答端”，再按提示复制
                / 粘贴 Offer / Answer JSON 信息。</p> <div class="mt-2 flex flex-wrap gap-2 items-center"><button type="button" class="border border-sky-700 bg-sky-600 px-3 py-1 text-xs uppercase tracking-[0.15em] text-white">我是发起端</button> <button type="button" class="border border-slate-400 bg-white px-3 py-1 text-xs uppercase tracking-[0.15em] text-slate-900 hover:bg-slate-100">我是应答端</button> <span class="ml-auto text-[11px] text-slate-500">当前角色： <!> </span></div></section> <!></div></main>`);function gt(De,Ae){Ke(Ae,!0);let m=u("none"),_=u(null),p=u(null),q=u(null),X=u(Oe({initiator:!1,responder:!1})),y=u(""),w=u(""),B=u(Oe([])),le=u(1),M=u(""),R=u(null),j=u(!1);function Ce(){a(m,"initiator"),a(y,""),a(w,""),pe()}function Je(){a(m,"responder"),a(y,""),a(w,""),$()}function Y(t,s){s!=="ping"&&a(B,[...e(B),{id:Se(le),from:t,kind:"text",text:s}],!0)}function Z(t,s){const v=URL.createObjectURL(s);a(B,[...e(B),{id:Se(le),from:t,kind:"image",url:v}],!0)}function E(t){console.log(t),Y("me",`[系统] ${t}`)}function $(){return e(_)?e(_):(a(_,new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),!0),e(_).oniceconnectionstatechange=()=>{const t=e(_)?.iceConnectionState;console.log("ICE state:",t),t==="connected"&&(a(j,!0),E("连接已建立，可以开始聊天。")),(t==="disconnected"||t==="failed"||t==="closed")&&(a(j,!1),ue(),E("连接已断开或失败。"))},e(_).ondatachannel=t=>{a(p,t.channel,!0),ce()},e(_))}function ce(){e(p)&&(e(p).onopen=()=>{a(q,setInterval(()=>{e(p)?.readyState==="open"&&(e(p).send("ping"),console.log("ping"))},16e3),!0)},e(p).onclose=()=>{E("DataChannel 已关闭。"),a(j,!1),ue(),e(q)&&(clearInterval(e(q)),a(q,null))},e(p).onmessage=t=>{const s=t.data;if(s instanceof ArrayBuffer){const v=new Blob([s]);Z("peer",v);return}s instanceof Blob?Z("peer",s):Y("peer",String(s??""))})}function de(t){return t.iceGatheringState==="complete"?Promise.resolve():new Promise(s=>{const v=()=>{t.iceGatheringState==="complete"&&(t.removeEventListener("icegatheringstatechange",v),s())};t.addEventListener("icegatheringstatechange",v)})}async function pe(){const t=$();a(p,t.createDataChannel("chat"),!0),ce();const s=await t.createOffer();await t.setLocalDescription(s),await de(t),a(y,JSON.stringify(t.localDescription),!0),E("已生成 Offer，请复制到对方浏览器。")}async function Ne(){const t=$();if(!e(w).trim()){alert("请先粘贴对方给你的 Offer JSON");return}const s=JSON.parse(e(w));await t.setRemoteDescription(s);const v=await t.createAnswer();await t.setLocalDescription(v),await de(t),a(y,JSON.stringify(t.localDescription),!0),e(X).responder=!0,E("已生成 Answer，请复制给对方。")}async function ve(){if(!e(_)){alert("请先在本窗口点击“创建 Offer”。");return}if(!e(w).trim()){alert("请先粘贴对方给你的 Answer JSON");return}const t=JSON.parse(e(w));await e(_).setRemoteDescription(t),E("已应用远端 Answer，等待连接建立…")}function fe(){if(!e(p)||e(p).readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}e(M).trim()&&(e(p).send(e(M)),Y("me",e(M)),a(M,""))}async function Re(){if(!e(p)||e(p).readyState!=="open"){alert("连接尚未建立或 DataChannel 未打开。");return}if(!e(R)||!e(R).files||e(R).files.length===0){alert("请先选择一张图片。");return}const t=e(R).files[0];if(t.size>2*1024*1024){alert("图片太大了，建议小于 2MB。");return}e(p).send(t),Z("me",t),e(R).value=""}async function be(){if(!e(y)?.trim()){alert("当前没有可复制的内容。");return}try{await navigator.clipboard.writeText(e(y))}catch(t){console.error(t),alert("复制失败，请手动选中内容复制。")}}function ue(){a(X,{responder:!1,initiator:!1},!0)}Fe(()=>{e(p)?.close(),e(_)?.close()});var ee=lt(),xe=i(ee),te=r(i(xe),2),me=r(i(te),4),_e=i(me);_e.__click=Ce;var ge=r(_e,2);ge.__click=Je;var he=r(ge,2),ye=r(i(he));{var Ie=t=>{var s=ie("发起端");c(t,s)},Te=t=>{var s=K(),v=A(s);{var ae=C=>{var P=ie("应答端");c(C,P)},re=C=>{var P=ie("未选择");c(C,P)};h(v,C=>{e(m)==="responder"?C(ae):C(re,!1)},!0)}c(t,s)};h(ye,t=>{e(m)==="initiator"?t(Ie):t(Te,!1)})}var Le=r(ye);l(he),l(me),l(te);var Be=r(te,2);{var Me=t=>{var s=it(),v=A(s),ae=i(v);{var re=o=>{var k=tt(),I=A(k),J=r(i(I),2);Q(J);var f=r(J,2),N=i(f);{var T=n=>{var d=Ye(),b=A(d);b.__click=Ne,H(2),c(n,d)},L=n=>{var d=K(),b=A(d);{var D=S=>{var U=Ze();U.__click=ve,c(S,U)},g=S=>{var U=$e();c(S,U)};h(b,S=>{e(m)==="initiator"?S(D):S(g,!1)},!0)}c(n,d)};h(N,n=>{e(m)==="responder"?n(T):n(L,!1)})}l(f),l(I);var G=r(I,2);{var O=n=>{var d=et(),b=r(i(d),2);Q(b);var D=r(b,2);D.__click=be,H(2),l(d),W(b,()=>e(y),g=>a(y,g)),c(n,d)};h(G,n=>{e(X).responder&&n(O)})}F(()=>V(J,"placeholder",e(m)==="responder"?"粘贴发起端给你的 Offer JSON":e(m)==="initiator"?"粘贴应答端给你的 Answer JSON":"请先在上方选择角色（发起端 / 应答端）")),W(J,()=>e(w),n=>a(w,n)),c(o,k)},C=o=>{var k=K(),I=A(k);{var J=f=>{var N=at(),T=A(N),L=r(i(T),2);Q(L);var G=r(L,2);G.__click=be;var O=r(G,2);O.__click=()=>{a(_,null),a(p,null),a(j,!1),pe()},H(2),l(T);var n=r(T,2),d=r(i(n),2);Q(d),V(d,"placeholder","粘贴应答端给你的 Answer JSON");var b=r(d,2),D=i(b);D.__click=ve,l(b),l(n),W(L,()=>e(y),g=>a(y,g)),W(d,()=>e(w),g=>a(w,g)),c(f,N)};h(I,f=>{e(m)==="initiator"&&f(J)},!0)}c(o,k)};h(ae,o=>{e(m)==="responder"?o(re):o(C,!1)})}l(v);var P=r(v,2),se=r(i(P),2),z=i(se);Ve(z),z.__keydown=o=>o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),fe());var je=r(z,2);je.__click=fe,l(se);var ne=r(se,2),we=i(ne);Xe(we,o=>a(R,o),()=>e(R));var Ee=r(we,2);Ee.__click=Re,H(2),l(ne);var ke=r(ne,2),Pe=i(ke);{var Ge=o=>{var k=rt();c(o,k)},Ue=o=>{var k=K(),I=A(k);He(I,17,()=>e(B),Qe,(J,f)=>{var N=ot(),T=i(N);{var L=O=>{var n=st(),d=i(n);l(n),F(()=>oe(d,`${e(f).from==="me"?"我：":"对方："}${e(f).text??""}`)),c(O,n)},G=O=>{var n=K(),d=A(n);{var b=D=>{var g=nt(),S=i(g),U=i(S,!0);l(S);var ze=r(S,2);l(g),F(()=>{oe(U,e(f).from==="me"?"我：":"对方："),V(ze,"src",e(f).url)}),c(D,g)};h(d,D=>{e(f).kind==="image"&&D(b)},!0)}c(O,n)};h(T,O=>{e(f).kind==="text"?O(L):O(G,!1)})}l(N),c(J,N)}),c(o,k)};h(Pe,o=>{e(B).length===0?o(Ge):o(Ue,!1)})}l(ke),l(P),F(()=>V(z,"placeholder",e(j)?"输入要发送的消息…":"请先完成上面的连接步骤")),W(z,()=>e(M),o=>a(M,o)),c(t,s)};h(Be,t=>{e(m)!=="none"&&t(Me)})}l(xe),l(ee),F(()=>oe(Le,` · 状态：${e(j)?"已连接 ✅":"未连接"}`)),c(De,ee),We()}qe(["click","keydown"]);export{gt as component};
